## Problem Description

The `send_webmentions_job` in the Azure Static Web Apps CI/CD workflow is failing with exit code 1. 

**Failing Job:** https://github.com/lqdev/luisquintanilla.me/actions/runs/21319856164/job/61368183283  
**Commit:** e1029b1931500f193d524d685a4333abb5ac14c5  
**Date:** 2026-01-24

### Error Logs

```
2026-01-24T18:49:54.5768388Z    at WebmentionService.sendWebmentions(Response[] responses)
2026-01-24T18:49:54.5769864Z    at <StartupCode$FSI_0001>.$FSI_0001.main@() in /home/runner/work/luisquintanilla.me/luisquintanilla.me/Scripts/send-webmentions.fsx:line 24
2026-01-24T18:49:54.5771489Z    at System.Reflection.MethodBaseInvoker.InterpretedInvoke_Method(Object obj, IntPtr* args)
2026-01-24T18:49:54.5773097Z    at System.Reflection.MethodBaseInvoker.InvokeWithNoArgs(Object obj, BindingFlags invokeAttr)
2026-01-24T18:49:54.5774196Z Stopped due to error
2026-01-24T18:49:54.6547512Z ##[error]Process completed with exit code 1.
```

## Root Cause Analysis

The error occurs in `Services/Webmention.fs` at line 31 in the `sendWebmentions` function:

```fsharp
let estTimeZone = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time")
```

**The Issue:** "Eastern Standard Time" is a **Windows-specific timezone identifier**. The GitHub Actions workflow runs on `ubuntu-latest` (Linux), which uses **IANA timezone identifiers** like "America/New_York".

When `TimeZoneInfo.FindSystemTimeZoneById()` is called with a Windows timezone ID on Linux, it throws a `TimeZoneNotFoundException`, causing the script to crash.

### Affected Files

1. **`Services/Webmention.fs`** (lines 27-41) - Contains the failing timezone lookup
2. **`Scripts/send-webmentions.fsx`** (line 24) - Calls the failing function
3. **`.github/workflows/publish-azure-static-web-apps.yml`** (lines 105-128) - The failing job definition

## Solution

### Fix 1: Cross-Platform Timezone Handling in `Services/Webmention.fs`

Replace lines 30-32 in `Services/Webmention.fs` with cross-platform timezone handling:

**Current Code (Broken on Linux):**
```fsharp
// Get current time in EST (-05:00) to match the timezone used in post metadata
let estTimeZone = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time")
let currentDateTime = TimeZoneInfo.ConvertTime(DateTimeOffset.Now, estTimeZone)
```

**Option A: Simple Try-Catch Approach**
```fsharp
// Get current time in EST (-05:00) to match the timezone used in post metadata
let estTimeZone = 
    try
        // Try Windows timezone ID first
        TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time")
    with
    | :? TimeZoneNotFoundException ->
        // Fall back to IANA timezone ID for Linux/macOS
        TimeZoneInfo.FindSystemTimeZoneById("America/New_York")
let currentDateTime = TimeZoneInfo.ConvertTime(DateTimeOffset.Now, estTimeZone)
```

**Option B: Cleaner Platform Detection**
```fsharp
// Get current time in EST (-05:00) to match the timezone used in post metadata
let estTimeZone = 
    let isWindows = System.Runtime.InteropServices.RuntimeInformation.IsOSPlatform(System.Runtime.InteropServices.OSPlatform.Windows)
    let tzId = if isWindows then "Eastern Standard Time" else "America/New_York"
    TimeZoneInfo.FindSystemTimeZoneById(tzId)
let currentDateTime = TimeZoneInfo.ConvertTime(DateTimeOffset.Now, estTimeZone)
```

### Fix 2: Enhanced Error Handling in `Scripts/send-webmentions.fsx`

Add better error handling and logging to make future failures easier to diagnose:

**Current Code (line 24-25):**
```fsharp
responses
|> WebmentionService.sendWebmentions
```

**Improved Code:**
```fsharp
try
    printfn $"Found {responses.Length} response(s) to process"
    responses |> WebmentionService.sendWebmentions
    printfn "Webmentions sent successfully"
with
| ex -> 
    eprintfn $"Error sending webmentions: {ex.Message}"
    eprintfn $"Stack trace: {ex.StackTrace}"
    exit 1
```

### Fix 3: Workflow Debugging Steps (Optional)

Add debug logging to the workflow to verify artifacts are being downloaded correctly:

In `.github/workflows/publish-azure-static-web-apps.yml`, after line 125, add:

```yaml
      - name: Verify artifacts
        run: |
          echo "Checking for required files..."
          ls -la _src/responses/ || echo "❌ _src/responses/ not found"
          ls -la bin/Debug/net10.0/PersonalSite.dll || echo "❌ PersonalSite.dll not found"
          echo "Files verified"
```

## Implementation Steps

1. Update `Services/Webmention.fs` with cross-platform timezone handling (use Option A or B above)
2. Add enhanced error handling to `Scripts/send-webmentions.fsx`
3. Test locally on Linux if possible: `dotnet fsi Scripts/send-webmentions.fsx`
4. Commit and push changes
5. Verify the `send_webmentions_job` passes in the next workflow run

## Testing

### Local Testing
```bash
# Build the project
dotnet build

# Run the webmentions script
dotnet fsi Scripts/send-webmentions.fsx
```

### CI Testing
Push changes and monitor the workflow at:
https://github.com/lqdev/luisquintanilla.me/actions/workflows/publish-azure-static-web-apps.yml

## Acceptance Criteria

- [ ] The `send_webmentions_job` completes successfully on Linux runners
- [ ] Timezone handling works on both Windows and Linux/macOS
- [ ] Error messages are clear and actionable if failures occur
- [ ] No regression in webmention sending functionality

## Priority

**High** - This job fails on every deployment, blocking the notification workflow.

## Related Files

- `Services/Webmention.fs` (lines 27-41)
- `Scripts/send-webmentions.fsx` (lines 1-25)
- `.github/workflows/publish-azure-static-web-apps.yml` (lines 105-128)
- `Domain.fs` (lines 374-403) - Response type definition

Labels: bug, high-priority