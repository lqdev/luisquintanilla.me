name: Azure Static Web Apps CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:      
  # pull_request:
  #   types: [opened, synchronize, reopened, closed]
  #   branches:
  #     - main

jobs:
  # ============================================================================
  # Main build and deployment job
  # Builds the F# static site generator, generates content, and deploys to Azure
  # Uploads artifacts for downstream notification jobs
  # ============================================================================
  build_and_deploy_job:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Deploy Job
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false
      
      - name: Setup .NET SDK 10.x
        uses: actions/setup-dotnet@v4
        with: 
          dotnet-version: '10.0.x'
          cache: false
      
      - name: Install Dependencies
        run: dotnet restore
      
      - name: Build project
        run: dotnet build --no-restore
      
      - name: Generate website
        run: dotnet run

      - name: Sync ActivityPub data for Azure Functions
        run: |
          echo "üì¶ Syncing generated ActivityPub data to Azure Functions directory..."
          echo "Syncing outbox data..."
          mkdir -p api/data/outbox
          cp -v _public/api/data/outbox/index.json api/data/outbox/index.json
          echo "Syncing followers data..."
          cp -v _public/api/data/followers.json api/data/followers.json
          echo "‚úÖ ActivityPub data synced successfully"
          echo "Outbox size: $(du -h api/data/outbox/index.json | cut -f1)"
          echo "Followers size: $(du -h api/data/followers.json | cut -f1)"

      - name: Check website sizes
        run: |
          echo "üöÄ TOTAL SITE SIZE: $(du -sh ./_public | cut -f1)"
          echo "================================================"
          chmod +x ./Scripts/check-site-sizes.sh
          ./Scripts/check-site-sizes.sh
      
      - name: Build And Deploy
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_NICE_WAVE_017E3760F }}
          repo_token: ${{ secrets.GITHUB_TOKEN }} # Used for Github integrations (i.e. PR comments)
          action: "upload"
          ###### Repository/Build Configurations - These values can be configured to match your app requirements. ######
          # For more information regarding Static Web App workflow configurations, please visit: https://aka.ms/swaworkflowconfig
          app_location: "./_public" # App source code path
          api_location: "./api" # Api source code path for Azure Functions
          output_location: "." # Built app content directory - optional
          skip_app_build: true # Skip build since we already built with F#
          skip_api_build: false # Let Azure build the Node.js API
          ###### End of Repository/Build Configurations ######
      
      # Upload artifacts for downstream notification jobs
      # These jobs run independently and need access to build outputs
      - name: Upload ActivityPub data for delivery queue
        uses: actions/upload-artifact@v4
        with:
          name: activitypub-artifacts
          path: _public/api/data/outbox/index.json
          retention-days: 1

  # ============================================================================
  # Webmention Notification Job (Independent)
  # Sends webmentions to notify other sites of new response content
  # Depends only on: build_and_deploy_job (for sequencing, not for artifacts)
  # Runs in parallel with: queue_activitypub_job
  # ============================================================================
  send_webmentions_job:
    needs: build_and_deploy_job
    runs-on: ubuntu-latest
    name: Send Webmentions
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          lfs: false
      
      - name: Setup .NET SDK 10.x
        uses: actions/setup-dotnet@v4
        with: 
          dotnet-version: '10.0.x'
          cache: false
      
      # The F# script uses inline NuGet references (#r "nuget:...") 
      # which are automatically restored by dotnet fsi when the script runs
      - name: Send Webmentions
        run: dotnet fsi Scripts/send-webmentions.fsx

  # ============================================================================
  # ActivityPub Delivery Queue Job (Independent)
  # Queues recent posts for federated delivery to ActivityPub followers
  # Depends only on: build_and_deploy_job
  # Runs in parallel with: send_webmentions_job
  # Only executes on main branch pushes (not PRs or manual triggers)
  # ============================================================================
  queue_activitypub_job:
    needs: build_and_deploy_job
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    name: Queue ActivityPub Posts
    env:
      ACTIVITYPUB_STORAGE_CONNECTION: ${{ secrets.ACTIVITYPUB_STORAGE_CONNECTION }}
    steps:
      - name: Download ActivityPub artifacts
        uses: actions/download-artifact@v4.1.8
        with:
          name: activitypub-artifacts
          path: _public/api/data/outbox/
      
      - name: Queue Recent Posts for Delivery
        run: |
          echo "üì¢ Queueing recent posts for delivery..."
          
          # Get the 2 most recent items from outbox using jq
          RECENT_ITEMS=$(jq -r '.orderedItems[:2] | .[] | @json' _public/api/data/outbox/index.json)
          
          if [ -z "$RECENT_ITEMS" ]; then
            echo "‚ö†Ô∏è No recent items found in outbox"
            exit 0
          fi
          
          # Extract connection details
          ACCOUNT_NAME=$(echo "$ACTIVITYPUB_STORAGE_CONNECTION" | grep -oP 'AccountName=\K[^;]+')
          ACCOUNT_KEY=$(echo "$ACTIVITYPUB_STORAGE_CONNECTION" | grep -oP 'AccountKey=\K[^;]+')
          
          # Queue each item
          echo "$RECENT_ITEMS" | while IFS= read -r create_activity; do
            # Extract note ID from the create activity
            NOTE_ID=$(echo "$create_activity" | jq -r '.object.id' | grep -oP '[^/]+$')
            
            if [ -z "$NOTE_ID" ]; then
              continue
            fi
            
            # Generate queue ID
            TIMESTAMP=$(date +%s%3N)
            RANDOM_HEX=$(openssl rand -hex 4)
            QUEUE_ID="post-${TIMESTAMP}-${RANDOM_HEX}"
            QUEUED_AT=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
            
            # Escape the create activity JSON for table storage
            CREATE_ESCAPED=$(echo "$create_activity" | jq -Rs .)
            
            # Build entity JSON
            ENTITY="{\"PartitionKey\":\"pending\",\"RowKey\":\"$QUEUE_ID\",\"noteId\":\"$NOTE_ID\",\"createActivity\":$CREATE_ESCAPED,\"status\":\"pending\",\"queuedAt\":\"$QUEUED_AT\",\"retryCount\":0}"
            
            # Insert into table using Azure REST API
            URL="https://${ACCOUNT_NAME}.table.core.windows.net/deliveryqueue"
            DATE=$(TZ=UTC date '+%a, %d %b %Y %H:%M:%S GMT')
            
            # Build canonicalized resource for SharedKeyLite
            CANONICALIZED_RESOURCE="/${ACCOUNT_NAME}/deliveryqueue"
            STRING_TO_SIGN="${DATE}\n${CANONICALIZED_RESOURCE}"
            SIGNATURE=$(printf "$STRING_TO_SIGN" | openssl dgst -sha256 -hmac "$(echo $ACCOUNT_KEY | base64 -d)" -binary | base64)
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$URL" \
              -H "x-ms-date: $DATE" \
              -H "x-ms-version: 2019-02-02" \
              -H "Authorization: SharedKeyLite $ACCOUNT_NAME:$SIGNATURE" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json;odata=nometadata" \
              -d "$ENTITY")
            
            if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "204" ]; then
              echo "‚úÖ Queued: $NOTE_ID"
            else
              echo "‚ö†Ô∏è Failed to queue $NOTE_ID (HTTP $HTTP_CODE)"
            fi
          done
          
          echo "üì¶ Queued posts will be delivered by scheduled worker (every 5 minutes)"

  # close_pull_request_job:
  #   if: github.event_name == 'pull_request' && github.event.action == 'closed'
  #   runs-on: ubuntu-latest
  #   name: Close Pull Request Job
  #   steps:
  #     - name: Close Pull Request
  #       id: closepullrequest
  #       uses: Azure/static-web-apps-deploy@v1
  #       with:
  #         azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_NICE_WAVE_017E3760F }}
  #         action: "close"
