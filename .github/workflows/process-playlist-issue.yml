name: Process Playlist Issue

on:
  issues:
    types: [opened]

jobs:
  process-playlist:
    # Only run if issue has "playlist" label AND issue author is @lqdev
    if: contains(github.event.issue.labels.*.name, 'playlist') && github.event.issue.user.login == 'lqdev'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          cache: true
          cache-dependency-path: '**/packages.lock.json'

      - name: Restore dependencies
        run: dotnet restore --locked-mode
          
      - name: Parse issue and extract form data
        id: extract-data
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // Extract form responses using regex patterns
              function extractFormValue(body, label) {
                // GitHub issue forms format: ### Label\n\nValue
                const regex = new RegExp(`### ${label}\\s*\\n\\s*\\n([\\s\\S]*?)(?=\\n\\n###|\\n\\n---|\$)`, 'i');
                const match = body.match(regex);
                const value = (match && match[1]) ? match[1].trim() : '';
                
                // Remove common artifacts from GitHub issue forms
                return value.replace(/^_No response_$/i, '').trim();
              }
              
              const issueBody = context.payload.issue.body;
              const title = extractFormValue(issueBody, 'Playlist Title');
              const spotifyUrl = extractFormValue(issueBody, 'Spotify Playlist URL');
              const commentary = extractFormValue(issueBody, 'Commentary \\(Optional\\)');
              const customSlug = extractFormValue(issueBody, 'Slug \\(Optional\\)');
              const tagsInput = extractFormValue(issueBody, 'Additional Tags \\(Optional\\)');
              
              console.log('Extracted title:', title);
              console.log('Extracted Spotify URL:', spotifyUrl);
              console.log('Extracted commentary:', commentary);
              console.log('Extracted custom slug:', customSlug);
              console.log('Extracted tags:', tagsInput);
              
              // Set outputs for playlist-creator and F# script
              core.setOutput('title', title);
              core.setOutput('spotify_url', spotifyUrl);
              core.setOutput('commentary', commentary);
              core.setOutput('slug', customSlug || '');
              core.setOutput('tags', tagsInput || '');
              
            } catch (error) {
              console.error('Error extracting issue data:', error);
              throw error;
            }
          
      - name: Build F# project
        run: dotnet build --no-restore
        
      - name: Install uv (Python package manager)
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          
      - name: Setup Python environment
        run: uv venv
        
      - name: Install playlist-creator tool
        run: |
          # Install playlist-creator and its dependencies using uv
          uv pip install git+https://github.com/lqdev/playlist-creator.git
          
      - name: Generate playlist content using playlist-creator
        id: generate-playlist
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
        run: |
          # Run playlist-creator to generate markdown content
          # The tool creates a markdown file in the output/ directory
          # Use --choice 1 for markdown output (batch mode is implicit via python -m)
          uv run python -m playlist_creator.main --url "${{ steps.extract-data.outputs.spotify_url }}" --choice 1
          
          # Find the generated markdown file in output/ directory
          MARKDOWN_FILE=$(find output -name "*.md" -type f | head -n 1)
          
          if [ -z "$MARKDOWN_FILE" ]; then
            echo "‚ùå Error: No markdown file found in output/ directory"
            exit 1
          fi
          
          # Copy the generated markdown to a known location
          cp "$MARKDOWN_FILE" /tmp/playlist_tracks.md
          
          echo "‚úÖ Playlist content generated successfully"
          echo "üìÑ Found markdown file: $MARKDOWN_FILE"
          echo "Generated content preview:"
          head -20 /tmp/playlist_tracks.md
        
      - name: Process issue with F# script
        id: process-issue
        env:
          ISSUE_TITLE: ${{ steps.extract-data.outputs.title }}
          ISSUE_SPOTIFY_URL: ${{ steps.extract-data.outputs.spotify_url }}
          ISSUE_COMMENTARY: ${{ steps.extract-data.outputs.commentary }}
          ISSUE_SLUG: ${{ steps.extract-data.outputs.slug }}
          ISSUE_TAGS: ${{ steps.extract-data.outputs.tags }}
        run: |
          # Create temporary files for safe parameter passing
          echo "$ISSUE_TITLE" > /tmp/title.txt
          echo "$ISSUE_SPOTIFY_URL" > /tmp/spotify_url.txt
          echo "$ISSUE_COMMENTARY" > /tmp/commentary.txt
          echo "$ISSUE_SLUG" > /tmp/slug.txt
          echo "$ISSUE_TAGS" > /tmp/tags.txt
          
          # Read playlist content generated by playlist-creator
          PLAYLIST_CONTENT=$(cat /tmp/playlist_tracks.md)
          echo "$PLAYLIST_CONTENT" > /tmp/playlist_content.txt
          
          # Run F# script with file-based parameters
          OUTPUT=$(dotnet fsi Scripts/process-playlist-issue.fsx -- \
            "$(cat /tmp/title.txt)" \
            "$(cat /tmp/spotify_url.txt)" \
            "$(cat /tmp/commentary.txt)" \
            "$(cat /tmp/slug.txt)" \
            "$(cat /tmp/tags.txt)" \
            "$(cat /tmp/playlist_content.txt)" 2>&1)
          EXIT_CODE=$?
          
          # Clean up temporary files and output directory
          rm -f /tmp/title.txt /tmp/spotify_url.txt /tmp/commentary.txt /tmp/slug.txt /tmp/tags.txt /tmp/playlist_content.txt /tmp/playlist_tracks.md
          rm -rf output/
          
          echo "Script output:"
          echo "$OUTPUT"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            # Extract filename from output
            FILENAME=$(echo "$OUTPUT" | grep "üìÅ File:" | sed 's/.*üìÅ File: _src\/playlists\///' | sed 's/ .*//')
            echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "error=$OUTPUT" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Create Pull Request
        if: steps.process-issue.outputs.success == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add playlist: ${{ steps.extract-data.outputs.title }}"
          title: "Add playlist: ${{ steps.extract-data.outputs.title }}"
          body: |
            ## New Playlist Post
            
            **Title:** ${{ steps.extract-data.outputs.title }}
            **Type:** playlist
            **Spotify URL:** ${{ steps.extract-data.outputs.spotify_url }}
            **File:** `_src/playlists/${{ steps.process-issue.outputs.filename }}`
            
            ### Processing Details
            - ‚úÖ Title: ${{ steps.extract-data.outputs.title }}
            - ‚úÖ Track information fetched from Spotify
            - ‚úÖ YouTube links generated for each track
            - ‚úÖ Commentary: ${{ steps.extract-data.outputs.commentary || 'None' }}
            - ‚úÖ Custom Slug: ${{ steps.extract-data.outputs.slug || 'Auto-generated' }}
            - ‚úÖ Additional Tags: ${{ steps.extract-data.outputs.tags || 'None (using defaults)' }}
            
            **Created via GitHub Issue Template #${{ github.event.issue.number }}**
            **Processed by playlist-creator (Python) + F# markdown generator**
          branch: content/issue-${{ github.event.issue.number }}/playlist/processed
          delete-branch: true
          
      - name: Close issue on success
        if: steps.process-issue.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              state: 'closed'
            });
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'üéâ Your playlist post has been processed successfully!\n\n**What happened:**\n- ‚úÖ Track information fetched from Spotify using playlist-creator\n- ‚úÖ YouTube links generated for each track\n- ‚úÖ Markdown file created with proper frontmatter and formatting\n- ‚úÖ Pull request created for review\n\nYou can track the progress in the pull requests tab.'
            });
            
      - name: Handle processing errors
        if: steps.process-issue.outputs.success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `‚ùå **Error processing playlist request**\n\n\`\`\`\n${{ steps.process-issue.outputs.error }}\n\`\`\`\n\nPlease check your issue format and Spotify URL, then try again. The issue will remain open for you to edit and resubmit.`
            });
