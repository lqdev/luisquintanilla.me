<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link rel="stylesheet" href="/assets/css/custom/main.css"><link rel="stylesheet" href="/assets/css/custom/timeline.css"><link rel="stylesheet" href="/assets/css/bootstrap-icons-1.5.0/bootstrap-icons.css"><link rel="stylesheet" href="/assets/css/highlight.github-dark-dimmed.min.css"><link rel="stylesheet" href="/assets/css/main.css"><link rel="stylesheet" href="/lib/revealjs/dist/reveal.css"><link rel="stylesheet" href="/lib/revealjs/dist/theme/black.css"><link rel="stylesheet" href="/lib/revealjs/plugin/highlight/monokai.css"><meta property="og:title" content="Mastodon Server Upgrades | Wiki | Luis Quintanilla"><meta property="og:type" content="website"><meta property="og:image" content="https://www.lqdev.me/avatar.png"><meta property="og:image:secure_url" content="https://www.lqdev.me/avatar.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="200"><meta property="og:image:height" content="200"><meta property="og:site_name" content="Luis Quintanilla Personal Website"><meta property="og:locale" content="en_US"><meta property="twitter:image" content="https://www.lqdev.me/avatar.png"><meta property="fediverse:creator" content="@lqdev@toot.lqdev.tech"><link rel="alternate" type="application/rss+xml" title="Luis Quintanilla Blog RSS Feed" href="/blog.rss"><link rel="alternate" type="application/rss+xml" title="Luis Quintanilla Microblog RSS Feed" href="/microblog.rss"><link rel="alternate" type="application/rss+xml" title="Luis Quintanilla Response RSS Feed" href="/responses.rss"><link rel="webmention" title="Luis Quintanilla Webmention Endpoint" href="https://webmentions.lqdev.tech/api/inbox"><link rel="feeds" type="text/xml" title="Luis Quintanilla&#39;s Feeds" href="/feed/index.opml"><link rel="blogroll" type="text/xml" title="Luis Quintanilla&#39;s Blogroll" href="/collections/blogroll/index.opml"><link rel="podroll" type="text/xml" title="Luis Quintanilla&#39;s Podroll" href="/collections/podroll/index.opml"><link rel="youtuberoll" type="text/xml" title="Luis Quintanilla&#39;s YouTube Roll" href="/collections/youtube/index.opml"><meta name="robots" content="nosnippet"><title>Mastodon Server Upgrades | Wiki | Luis Quintanilla</title></head><body><button class="mobile-toggle" id="mobile-nav-toggle" aria-label="Toggle navigation menu" aria-expanded="false"><div class="hamburger"><span></span><span></span><span></span></div></button><div class="nav-overlay" id="nav-overlay"></div><nav class="desert-nav" id="sidebar-menu" role="navigation" aria-label="Main navigation"><div class="nav-brand"><a href="/" class="brand-text"><img src="/avatar.png" alt="Luis Quintanilla avatar" loading="lazy">Luis Quintanilla</a></div><div class="nav-section"><a class="nav-link" href="/"><svg class="nav-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L8.354 1.146zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4H2.5z"></path></svg>Home</a><a class="nav-link" href="/about"><svg class="nav-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"></path></svg>About</a><a class="nav-link" href="/contact"><svg class="nav-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"></path></svg>Contact</a><a class="nav-link" href="/search"><svg class="nav-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"></path></svg>Search</a><a class="nav-link" href="/feed"><svg class="nav-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-3-8.5a1 1 0 0 1 1-1c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1-1-1zm0 4a1 1 0 0 1 1-1 6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1-1-1z"></path></svg>Subscribe</a></div><div class="nav-section dropdown"><button class="nav-link dropdown-toggle" data-target="collections-dropdown"><svg class="nav-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M2.5 3A1.5 1.5 0 0 0 1 4.5v.793c.026.009.051.02.076.032L7.674 8.51c.206.1.446.1.652 0l6.598-3.185A.755.755 0 0 1 15 5.293V4.5A1.5 1.5 0 0 0 13.5 3h-11Z"></path><path d="M15 6.954 8.978 9.86a2.25 2.25 0 0 1-1.956 0L1 6.954V11.5A1.5 1.5 0 0 0 2.5 13h11a1.5 1.5 0 0 0 1.5-1.5V6.954Z"></path></svg>Collections<svg class="dropdown-arrow" viewBox="0 0 16 16" fill="currentColor"><path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"></path></svg></button><div class="dropdown-menu" id="collections-dropdown"><a class="dropdown-item" href="/collections/blogroll">Blogroll</a><a class="dropdown-item" href="/collections/podroll">Podroll</a><a class="dropdown-item" href="/collections/youtube">YouTube</a><a class="dropdown-item" href="/collections/forums">Forums</a><div class="dropdown-divider"></div><a class="dropdown-item" href="/collections/starter-packs">Starter Packs</a><div class="dropdown-divider"></div><a class="dropdown-item" href="/radio">Radio</a><a class="dropdown-item" href="/tags">Tags</a></div></div><div class="nav-section dropdown"><button class="nav-link dropdown-toggle" data-target="resources-dropdown"><svg class="nav-icon" viewBox="0 0 16 16" fill="currentColor"><path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811V2.828zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492V2.687zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783z"></path></svg>Resources<svg class="dropdown-arrow" viewBox="0 0 16 16" fill="currentColor"><path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"></path></svg></button><div class="dropdown-menu" id="resources-dropdown"><a class="dropdown-item" href="/resources/snippets">Snippets</a><a class="dropdown-item" href="/resources/wiki">Wiki</a><a class="dropdown-item" href="/resources/presentations">Presentations</a></div></div><div class="theme-toggle"><button class="theme-toggle-btn" id="theme-toggle" aria-label="Toggle dark mode"><span id="theme-toggle-icon">☀️</span><span>Theme</span></button></div></nav><main role="main" class="main-content" id="main-content"><div class="content-wrapper"><div class="mr-auto"><article class="h-entry individual-post"><header class="post-header"><h1 class="p-name post-title">Mastodon Server Upgrades</h1><div class="post-meta"><time class="dt-published" datetime="07/14/2024 03:16 -05:00">July 14, 2024</time></div><div class="u-author h-card microformat-hidden"><img src="/avatar.png" class="u-photo" alt="Luis Quintanilla" /><a href="/about" class="u-url p-name">Luis Quintanilla</a></div></header><div class="e-content post-content"><h2>Overview</h2>
<p>This provides a guide for upgrading specific versions.</p>
<h2>Backup Instructions</h2>
<p>These instructions backup the database and environment variables file. It does not back-up media files.</p>
<ol>
<li>Create new directory called <em>backups/&lt;DATE&gt;</em>.</li>
<li>Copy <em>live/.env.production</em> to <em>backups/&lt;DATE&gt;</em> directory.</li>
<li>Dump database <code>pg_dump -Fc mastodon_production -f /home/mastodon/backups/&lt;DATE&gt;/backup.dump</code></li>
</ol>
<h2>Versions</h2>
<h3>3.4.1</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file.</li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 3.4.1 tag - <code>git checkout v3.4.1</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Migrate DB - <code>RAILS_ENV=production bundle exec rails db:migrate</code></li>
<li>Precompile Assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>3.4.2</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file.</li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 3.4.2 tag - <code>git checkout v3.4.2</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Migrate DB - <code>RAILS_ENV=production bundle exec rails db:migrate</code></li>
<li>Precompile Assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>3.4.3</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 3.4.3 tag - <code>git checkout v3.4.3</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Migrate DB - <code>RAILS_ENV=production bundle exec rails db:migrate</code></li>
<li>Precompile Assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>3.4.4</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 3.4.4 tag - <code>git checkout v3.4.4</code></li>
<li>Precompile Assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>3.4.5</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 3.4.5 tag - <code>git checkout v3.4.5</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>3.4.6</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 3.4.6 tag - <code>git checkout v3.4.6</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>3.4.7</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 3.4.7 tag - <code>git checkout v3.4.7</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>3.5.0</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Checkout 3.5.0 tag - <code>git checkout v3.5.0</code></li>
<li>Update available rbenv version - <code>git -C /home/mastodon/.rbenv/plugins/ruby-build pull</code></li>
<li>Install Ruby 3.0.3 - <code>RUBY_CONFIGURE_OPTS=--with-jemalloc rbenv install 3.0.3</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Run predeployment DB migration - <code>SKIP_POST_DEPLOYMENT_MIGRATIONS=true RAILS_ENV=production bundle exec rails db:migrate</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Update service files - <code>cp /home/mastodon/live/dist/mastodon-*.service /etc/systemd/system/</code></li>
<li>Reload systemd daemon - <code>systemctl daemon-reload</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
<li>Clear cache - <code>RAILS_ENV=production bin/tootctl cache clear</code></li>
<li>Run postdeployment DB migration - <code>RAILS_ENV=production bundle exec rails db:migrate</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>3.5.1</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 3.5.1 tag - <code>git checkout v3.5.1</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>3.5.2</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 3.5.2 tag - <code>git checkout v3.5.2</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Run predeployment DB migration - <code>SKIP_POST_DEPLOYMENT_MIGRATIONS=true RAILS_ENV=production bundle exec rails db:migrate</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
<li>Run postdeployment DB migration - <code>RAILS_ENV=production bundle exec rails db:migrate</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>3.5.3</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 3.5.3 tag - <code>git checkout v3.5.3</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>4.0.0</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Upgade NodeJS - <code>curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash - &amp;&amp; sudo apt-get install -y nodejs</code></li>
<li>Install Ruby 3.0.4 - <code>RUBY_CONFIGURE_OPTS=--with-jemalloc rbenv install 3.0.4</code></li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 4.0.0 tag - <code>git checkout v4.0.0</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Run predeployment DB migration - <code>SKIP_POST_DEPLOYMENT_MIGRATIONS=true RAILS_ENV=production bundle exec rails db:migrate</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Update service files - <code>cp /home/mastodon/live/dist/mastodon-*.service /etc/systemd/system/</code></li>
<li>Reload systemd daemon - <code>systemctl daemon-reload</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
<li>Run postdeployment DB migration - <code>RAILS_ENV=production bundle exec rails db:migrate</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>4.0.2</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 4.0.2 tag - <code>git checkout v4.0.2</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<p>NOTE: Node 18 not supported yet. If you run into issues upgrading directly from 3.5.3, checkout v4.0.0 tag and the upgrade to v4.0.2</p>
<h3>4.1.0</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch --tags</code></li>
<li>Checkout 4.1.0 tag - <code>git checkout v4.1.0</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Run DB migration - <code>RAILS_ENV=production bundle exec rails db:migrate</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>4.1.1</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.1.1 tag - <code>git checkout v4.1.1</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>4.1.2</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.1.3 tag - <code>git checkout v4.1.2</code></li>
<li>Update rbenv version - <code>git -C /home/mastodon/.rbenv/plugins/ruby-build pull</code></li>
<li>Install Ruby 3.0.6 - <code>RUBY_CONFIGURE_OPTS=--with-jemalloc rbenv install 3.0.6</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>4.1.3</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.1.3 tag - <code>git checkout v4.1.3</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>(Optional) Upgrade reverse proxy <code>Content-Security-Policy: default-src 'none'; form-action 'none'</code> &amp; <code>X-Content-Type-Options: nosniff</code>. More info can be found in <em>dist/nginx.conf</em>.</li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>4.1.4</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.1.4 tag - <code>git checkout v4.1.4</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>(Optional) Upgrade reverse proxy <code>Content-Security-Policy: default-src 'none'; form-action 'none'</code> &amp;<code>X-Content-Type-Options: nosniff</code>. More info can be found in <em>dist/nginx.conf</em>.</li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>4.1.5</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.1.5 tag - <code>git checkout v4.1.5</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>4.1.6</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.1.6 tag - <code>git checkout v4.1.6</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>4.1.7</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.1.7 tag - <code>git checkout v4.1.7</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>4.1.8</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.1.8 tag - <code>git checkout v4.1.8</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>4.1.9</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.1.9 tag - <code>git checkout v4.1.9</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
</ol>
<h3>4.2.0</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.1.9 tag - <code>git checkout v4.2.0</code></li>
<li>Update Streaming Server Service
<ol>
<li><code>sudo cp ~mastodon/live/dist/mastodon-streaming*.service /etc/systemd/system/</code></li>
<li><code>sudo systemctl daemon-reload</code></li>
</ol>
</li>
<li>Update rbenv version - <code>git -C /home/mastodon/.rbenv/plugins/ruby-build pull</code></li>
<li>Install Ruby 3.2.2 - <code>RUBY_CONFIGURE_OPTS=--with-jemalloc rbenv install 3.2.2</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Run predeployment DB migration - <code>SKIP_POST_DEPLOYMENT_MIGRATIONS=true RAILS_ENV=production bundle exec rails db:migrate</code></li>
<li>Restart services - <code>systemctl start mastodon-sidekiq mastodon-web mastodon-streaming</code></li>
<li>Run postdeployment DB migration - <code>RAILS_ENV=production bundle exec rails db:migrate</code></li>
</ol>
<h3>4.2.1</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.1 tag - <code>git checkout v4.2.1</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
</ol>
<h3>4.2.2</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.2 tag - <code>git checkout v4.2.2</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
</ol>
<h3>4.2.3</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.3 tag - <code>git checkout v4.2.3</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
</ol>
<h3>4.2.4</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.4 tag - <code>git checkout v4.2.4</code></li>
<li>Update rbenv version - <code>git -C /home/mastodon/.rbenv/plugins/ruby-build pull</code></li>
<li>Install Ruby 3.2.3 - <code>RUBY_CONFIGURE_OPTS=--with-jemalloc rbenv install 3.2.3</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
</ol>
<h3>4.2.5</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.5 tag - <code>git checkout v4.2.5</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
</ol>
<h3>4.2.6</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.6 tag - <code>git checkout v4.2.6</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
</ol>
<h3>4.2.7</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.7 tag - <code>git checkout v4.2.7</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
</ol>
<h3>4.2.8</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.8 tag - <code>git checkout v4.2.8</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
</ol>
<h3>4.2.9</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.9 tag - <code>git checkout v4.2.9</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
</ol>
<h3>4.2.10</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.10 tag - <code>git checkout v4.2.10</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
</ol>
<h3>4.2.11</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.11 tag - <code>git checkout v4.2.11</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
</ol>
<h3>4.2.12</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.12 tag - <code>git checkout v4.2.12</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
</ol>
<h3>4.2.13</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.2.13 tag - <code>git checkout v4.2.13</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --frozen-lockfile</code></li>
</ol>
<h3>4.3.0 NOT WORKING</h3>
<ol>
<li>Stop services - <code>systemctl stop mastodon-*.service</code></li>
<li>Backup database and env file</li>
<li>Fetch tags - <code>git fetch &amp;&amp; git fetch --tags</code></li>
<li>Checkout 4.3.0 tag - <code>git checkout v4.3.0</code></li>
<li>Install yarn4 - <code>corepack enable</code> then, <code>corepack prepare</code></li>
<li>Install Ruby dependencies - <code>bundle install</code></li>
<li>Install JS dependencies - <code>yarn install --immutable</code></li>
<li>Generate secrets - <code>RAILS_ENV=production bin/rails db:encryption:init</code></li>
<li>Copy secrets to <code>.env.production</code> file</li>
<li>Precompile assets - <code>RAILS_ENV=production bundle exec rails assets:precompile</code></li>
<li>Run predeployment database migrations - <code>SKIP_POST_DEPLOYMENT_MIGRATIONS=true RAILS_ENV=production bundle exec rails db:migrate</code></li>
<li>Restart services - <code>sudo systemctl restart mastodon-sidekiq mastodon-streaming mastodon-web</code></li>
<li>Run postdeployment database migrations - <code>RAILS_ENV=production bundle exec rails db:migrate</code></li>
</ol>
<h2>Restart Services</h2>
<pre><code class="language-bash">sudo systemctl restart mastodon-sidekiq mastodon-streaming mastodon-web
</code></pre>
<h2>Documentation</h2>
<ul>
<li>https://docs.joinmastodon.org/admin/troubleshooting/index-corruption</li>
<li>https://docs.joinmastodon.org/admin/install/</li>
<li>https://docs.joinmastodon.org/admin/upgrading/</li>
<li>https://docs.joinmastodon.org/admin/backups/</li>
<li>https://docs.joinmastodon.org/admin/migrating/</li>
<li>https://docs.joinmastodon.org/admin/tootctl/</li>
</ul>
</div><footer class="post-footer"><div class="permalink-info">Permalink: <a class="u-url permalink-link" href="/resources/wiki/mastodon-server-upgrades/">/resources/wiki/mastodon-server-upgrades/</a></div><div><script type="application/javascript">window.onload = function() { document.getElementById('webmention-target').value = window.location.href }</script><form action="https://webmentions.lqdev.tech/api/inbox" method="POST" enctype="application/x-www-form-urlencoded"><h5 class="text-center">Send me a <a href="/contact">message</a> or <a href="https://indieweb.org/webmentions">webmention</a></h5><div class="form-row justify-content-center"><div class="w-75"><input type="url" class="form-control" name="source" placeholder="Your URL (webmention source)" required /></div><div class="col-auto"><input type="submit" class="btn btn-primary" value="Send" /></div><input type="hidden" readonly name="target" id="webmention-target" /></div></form></div></footer></article></div></div></main><script src="/assets/lib/jquery/jquery.slim.min.js"></script><script src="/assets/lib/boostrap/bootstrap.min.js"></script><script src="/assets/lib/highlight/highlight.min.js"></script><script src="/assets/lib/highlight/highlight.fsharp.min.js"></script><script src="/assets/lib/highlight/highlight.nix.min.js"></script><script src="/assets/js/timeline.js"></script><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script type="application/javascript">mermaid.initialize({startOnLoad:true});</script><script type="application/javascript">hljs.initHighlightingOnLoad();</script><script src="/lib/revealjs/dist/reveal.js"></script><script src="/lib/revealjs/plugin/markdown/markdown.js"></script><script src="/lib/revealjs/plugin/highlight/highlight.js"></script><script type="application/javascript">
                    // Initialize Reveal.js when a presentation container is found on the page
                    document.addEventListener('DOMContentLoaded', function() {
                        const presentationContainer = document.querySelector('.presentation-container');
                        if (presentationContainer && typeof Reveal !== 'undefined') {
                            Reveal.initialize({
                                plugins: [RevealMarkdown, RevealHighlight],
                                embedded: true
                            });
                        }
                    });
                    </script></body><footer><a rel="me" href="https://toot.lqdev.tech/@lqdev"></a><a rel="me" href="https://github.com/lqdev"></a><a rel="me" href="https://twitter.com/ljquintanilla"></a><a rel="me" href="https://www.linkedin.com/in/lquintanilla01/"></a><a rel="me" href="mailto:lqdev@outlook.com"></a></footer></html>