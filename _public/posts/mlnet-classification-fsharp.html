<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/bootstrap-icons-1.5.0/bootstrap-icons.css"><link rel="stylesheet" href="/css/highlight-dark.min.css"><link rel="stylesheet" href="/css/main.css"><meta property="og:title" content="Classification with F# ML.NET Models - Luis Quintanilla"><meta property="og:type" content="website"><meta property="og:image" content="https://www.luisquintanilla.me/avatar.png"><meta property="og:image:secure_url" content="https://www.luisquintanilla.me/avatar.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="200"><meta property="og:image:height" content="200"><meta property="og:site_name" content="Luis Quintanilla Personal Website"><meta property="og:locale" content="en_US"><meta property="twitter:image" content="https://www.luisquintanilla.me/avatar.png"><link rel="alternate" type="application/rss+xml" title="Luis Quintanilla Blog RSS Feed" href="https://www.luisquintanilla.me/posts/index.xml"><link rel="alternate" type="application/rss+xml" title="Luis Quintanilla Main Feed (Microblog) RSS" href="https://www.luisquintanilla.me/feed/index.xml"><link rel="alternate" type="application/rss+xml" title="Luis Quintanilla Notes Feed RSS" href="https://www.luisquintanilla.me/feed/notes.xml"><link rel="alternate" type="application/rss+xml" title="Luis Quintanilla Videos Feed RSS" href="https://www.luisquintanilla.me/feed/videos.xml"><meta name="robots" content="noindex,nofollow,nosnippet"><title>Classification with F# ML.NET Models - Luis Quintanilla</title></head><body><nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark"><a class="navbar-brand" href="/"><img src="/avatar.png" height="32" width="32" class="d-inline-block align-top rounded-circle" style="margin-right:5px">Luis Quintanilla</a><button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarCollapse"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="aboutDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">About</a><div class="dropdown-menu" aria-labelledby="aboutDropdown"><a class="dropdown-item" href="/about.html">About Me</a><a class="dropdown-item" href="/irl-stack.html">IRL Stack</a><a class="dropdown-item" href="/colophon.html">Colophon</a></div></li><li class="nav-item"><a class="nav-link" href="/contact.html">Contact</a></li><li class="nav-item"><a class="nav-link" href="/posts/1">Blog</a></li><li class="nav-item"><a class="nav-link" href="/events.html">Events</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="feedDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Feeds</a><div class="dropdown-menu" aria-labelledby="feedDropdown"><a class="dropdown-item" href="/feed/index.html">Main</a><a class="dropdown-item" href="/feed/notes.html">Notes</a><a class="dropdown-item" href="/feed/videos.html">Videos</a><div class="dropdown-divider"></div><a class="dropdown-item" href="/feed/blogroll.html">Blogroll</a></div></li></ul><a href="/about.html#subscribe"><svg class="bi bi-rss text-secondary" fill="currentColor" viewBox="0 0 16 16" height="32" width="32"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"></path><path d="M5.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-3-8.5a1 1 0 0 1 1-1c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1-1-1zm0 4a1 1 0 0 1 1-1 6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1-1-1z"></path></svg></a></div></nav><main role="main" class="container"><div class="mr-auto"><h1>Introduction</h1>
<p>In a previous <a href="http://luisquintanilla.me/2018/05/11/deploy-netml-docker-aci/">post</a>, I detailed how to build and deploy C# <code>ML.NET</code> models with <code>Docker</code> and <code>ASP.NET Core</code>. With inspiration from <a href="https://twitter.com/csharpfritz">Jeff Fritz</a>, I have been learning F# for the past week and a half or so. When trying to think of projects to start practicing my F#, porting over the code I had built in C# naturally came to mind. After overcoming many obstacles and with much guidance from <a href="https://github.com/voronoipotato">Alan Ball</a> and <a href="https://twitter.com/isaac_abraham">Isaac Abraham</a> whose F# <a href="https://www.amazon.com/Get-Programming-guide-NET-developers/dp/1617293997/ref=sr_1_1?ie=UTF8&amp;qid=1528929802&amp;sr=8-1&amp;keywords=get+programming+with+F%23">book</a> I highly recommend, I was able to successfully port over the main parts of my code which highlight <code>ML.NET</code> functionality. In this writeup, I will port a C# <code>ML.NET</code> classification model to F# which predicts the type of flower based on four numerical measurement inputs. I tried to keep the organization of this post nearly identical to that of the C# article where possible. Sample code for this project can be found at the following <a href="https://github.com/lqdev/fsmlnetdemo">link</a>.</p>
<h2>Prerequisites</h2>
<p>This project was built on a Linux PC but should work cross-platform on Mac and Windows.</p>
<ul>
<li><a href="https://www.microsoft.com/net/download/linux">.NET Core SDK 2.0+</a></li>
<li><a href="https://fsharp.org/use/linux/">Ionide Extension - Option 1</a></li>
<li><a href="https://www.nuget.org/packages/Microsoft.ML/">ML.NET v 0.2.0</a></li>
</ul>
<h2>Setting Up The Project</h2>
<p>The first thing we want to do is create a folder for our solution.</p>
<pre><code class="language-bash">mkdir fsharpmlnetdemo
</code></pre>
<p>Then, we want to create a solution inside our newly created folder.</p>
<pre><code class="language-bash">cd fsharpmlnetdemo
dotnet new sln
</code></pre>
<h2>Building The Model</h2>
<h3>Setting Up The Model Project</h3>
<p>First, we want to create the project. From the solution folder enter:</p>
<pre><code class="language-bash">dotnet new console -o model -lang f#
</code></pre>
<p>Now we want to add this new project to our solution.</p>
<pre><code class="language-bash">dotnet sln add model/model.fsproj
</code></pre>
<h3>Adding Dependencies</h3>
<p>Since we’ll be using the <code>ML.NET</code> framework, we need to add it to our <code>model</code> project.</p>
<pre><code class="language-bash">dotnet add model/model.fsproj package Microsoft.ML
</code></pre>
<h3>Download The Data</h3>
<p>Before we start training the model, we need to download the data we’ll be using to train. We do so by downloading the data file into our root solution directory.</p>
<pre><code class="language-bash">curl -o iris-data.txt https://archive.ics.uci.edu/ml/machine-learning-databases/iris/iris.data
</code></pre>
<p>If we take a look at the data file, it should look something like this:</p>
<pre><code class="language-bash">5.1,3.5,1.4,0.2,Iris-setosa
4.9,3.0,1.4,0.2,Iris-setosa
4.7,3.2,1.3,0.2,Iris-setosa
4.6,3.1,1.5,0.2,Iris-setosa
5.0,3.6,1.4,0.2,Iris-setosa
5.4,3.9,1.7,0.4,Iris-setosa
4.6,3.4,1.4,0.3,Iris-setosa
5.0,3.4,1.5,0.2,Iris-setosa
4.4,2.9,1.4,0.2,Iris-setosa
4.9,3.1,1.5,0.1,Iris-setosa
</code></pre>
<h3>Train Model</h3>
<p>Now that we have all our dependencies set up, it’s time to build our model. I leveraged the demo that is used on the <code>ML.NET</code> Getting-Started <a href="https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet/get-started/linux/ubuntu16-04">website</a>.</p>
<h4>Defining Data Structures</h4>
<p>At the time of this writing, <code>ML.NET</code> version <code>0.2.0</code> does not fully support F# Records. A workaround for this are mutable classes. Not really inline with F# paradigms, but it should be good enough.</p>
<p>In the <code>Program.fs</code> file of our <code>model</code> project directory, let’s create two mutable classes called <code>IrisData</code> and <code>IrisPrediction</code> which will define our features and predicted attribute respectively. Both of them will use <code>Microsoft.ML.Runtime.Api</code> to add the property attributes.</p>
<p>Here is what our <code>IrisData</code> class looks like:</p>
<pre><code class="language-fsharp">type IrisData() =
    [&lt;Column(ordinal = &quot;0&quot;);DefaultValue&gt;]
    val mutable public SepalLength: float32

    [&lt;Column(ordinal = &quot;1&quot;);DefaultValue&gt;]
    val mutable public SepalWidth: float32

    [&lt;Column(ordinal = &quot;2&quot;);DefaultValue&gt;]
    val mutable public PetalLength:float32

    [&lt;Column(ordinal = &quot;3&quot;);DefaultValue&gt;]
    val mutable public PetalWidth:float32

    [&lt;Column(ordinal = &quot;4&quot;,name=&quot;Label&quot;);DefaultValue&gt;]
    val mutable public Label: string
</code></pre>
<p>Similarly, here is the <code>IrisPrediction</code> class:</p>
<pre><code class="language-fsharp">type IrisPrediction() =
    [&lt;ColumnName &quot;PredictedLabel&quot;;DefaultValue&gt;] val mutable public PredictedLabel : string
</code></pre>
<h4>Building Training Pipeline</h4>
<p>The way the <code>ML.NET</code> computations process is via a sequential pipeline of steps that are performed eventually leading up to the training of the model. We can add that logic inside the <code>main</code> function of our <code>Program.fs</code> file.</p>
<pre><code class="language-fsharp">let dataPath = &quot;./iris-data.txt&quot;

// Initialize Compute Graph
let pipeline = new LearningPipeline()

// Load Data
pipeline.Add((new TextLoader(dataPath).CreateFrom&lt;IrisData&gt;separator=','))

// Transform Data
// Assign numeric values to text in the &quot;Label&quot; column, because
// only numbers can be processed during model training
pipeline.Add(new Transforms.Dictionarizer(&quot;Label&quot;))

// Vectorize Features
pipeline.Add(new ColumnConcatenator(&quot;Features&quot;,&quot;SepalLength&quot;, &quot;SepalWidth&quot;, &quot;PetalLength&quot;, &quot;PetalWidth&quot;))

// Add Learner
pipeline.Add(new StochasticDualCoordinateAscentClassifier())

// Convert Label back to text
pipeline.Add(new ransforms.PredictedLabelColumnOriginalValueConverterPredictedLabelColumn = &quot;PredictedLabel&quot;))

//Train the model
let model = pipeline.Train&lt;IrisData, IrisPrediction&gt;()
</code></pre>
<h4>Testing Our Model</h4>
<p>Now that we have our data structures and model trained, it’s time to test it to make sure it's working. Following our training operation, we can add the following code.</p>
<pre><code class="language-fsharp">// Test data for prediction
let testInstance = IrisData()
testInstance.SepalLength &lt;- 3.3f
testInstance.SepalWidth &lt;- 1.6f
testInstance.PetalLength &lt;- 0.2f
testInstance.PetalWidth &lt;- 5.1f

//Get Prediction
let prediction = model.Predict(testInstance)

//Output Prediction
printfn &quot;Predicted flower type is: %s&quot; prediction.PredictedLabel
</code></pre>
<p>Our final <code>Program.fs</code> file should contain content similar to that below:</p>
<pre><code class="language-fsharp">open System
open Microsoft.ML
open Microsoft.ML.Runtime
open Microsoft.ML.Runtime.Api
open Microsoft.ML.Data
open Microsoft.ML.Transforms
open Microsoft.ML.Trainers

type IrisData() =

    [&lt;Column(ordinal = &quot;0&quot;);DefaultValue&gt;] val mutable public SepalLength: float32
    [&lt;Column(ordinal = &quot;1&quot;);DefaultValue&gt;] val mutable public SepalWidth: float32
    [&lt;Column(ordinal = &quot;2&quot;);DefaultValue&gt;] val mutable public PetalLength:float32
    [&lt;Column(ordinal = &quot;3&quot;);DefaultValue&gt;] val mutable public PetalWidth:float32
    [&lt;Column(ordinal = &quot;4&quot;,name=&quot;Label&quot;);DefaultValue&gt;] val mutable public Label: string


type IrisPrediction() =

    [&lt;ColumnName &quot;PredictedLabel&quot;;DefaultValue&gt;] val mutable public PredictedLabel : string

[&lt;EntryPoint&gt;]
let main argv =

    let dataPath = &quot;./iris-data.txt&quot;

    // Initialize Compute Graph
    let pipeline = new LearningPipeline()

    // Load Data
    pipeline.Add((new TextLoader(dataPath)).CreateFrom&lt;IrisData&gt;(separator=','))

    // Transform Data
    // Assign numeric values to text in the &quot;Label&quot; column, because
    // only numbers can be processed during model training
    pipeline.Add(new Transforms.Dictionarizer(&quot;Label&quot;))

    // Vectorize Features
    pipeline.Add(new ColumnConcatenator(&quot;Features&quot;,&quot;SepalLength&quot;, &quot;SepalWidth&quot;, &quot;PetalLength&quot;, &quot;PetalWidth&quot;))

    // Add Learner
    pipeline.Add(new StochasticDualCoordinateAscentClassifier())

    // Convert Label back to text
    pipeline.Add(new Transforms.PredictedLabelColumnOriginalValueConverter(PredictedLabelColumn = &quot;PredictedLabel&quot;))

    //Train the model
    let model = pipeline.Train&lt;IrisData, IrisPrediction&gt;()

    // Test data for prediction
    let testInstance = IrisData()
    testInstance.SepalLength &lt;- 3.3f
    testInstance.SepalWidth &lt;- 1.6f
    testInstance.PetalLength &lt;- 0.2f
    testInstance.PetalWidth &lt;- 5.1f

    //Get Prediction
    let prediction = model.Predict(testInstance)

    //Output Prediction
    printfn &quot;Predicted flower type is: %s&quot; prediction.PredictedLabel
    0 // return an integer exit code
</code></pre>
<p>All set to run. We can do so by entering the following command from our solution directory:</p>
<pre><code class="language-fsharp">dotnet run -p model/model.fsproj
</code></pre>
<p>Once the application has been run, the following output should display on the console.</p>
<pre><code class="language-bash">Automatically adding a MinMax normalization transform, use 'norm=Warn' or 'norm=No' to turn this behavior off.
Using 2 threads to train.
Automatically choosing a check frequency of 2.
Auto-tuning parameters: maxIterations = 9998.
Auto-tuning parameters: L2 = 2.667734E-05.Auto-tuning parameters: L1Threshold (L1/L2) = 0.
Using best model from iteration 1066.Not training a calibrator because it is not needed.
Predicted flower type is: Iris-virginica
</code></pre>
<h2>Conclusion</h2>
<p>In this post, we ported over a C# <code>ML.NET</code> classification model to F# which predicts the class of flower based on numerical measurement inputs. While several workarounds needed to be made, <code>ML.NET</code> is still in its infancy. As more people become involved and provide feedback hopefully in the near future, F# support and functionality will become more stable. Happy coding!</p>
</div></main><script src="/lib/jquery/jquery.slim.min.js"></script><script src="/lib/boostrap/bootstrap.min.js"></script><script src="/lib/highlight/highlight.min.js"></script><script src="/lib/highlight/highlight.fsharp.min.js"></script><script type="application/javascript">hljs.initHighlightingOnLoad();</script></body><footer><a rel="me" href="https://toot.lqdev.tech/@lqdev"></a></footer></html>