<!DOCTYPE html>
<html lang="en"><head><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/bootstrap-icons-1.5.0/bootstrap-icons.css"><link rel="stylesheet" href="/css/highlight-dark.min.css"><link rel="stylesheet" href="/css/main.css"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta property="og:title" content="Use machine learning to categorize web links with F# and ML.NET"><meta property="og:type" content="website"><meta property="og:image" content="https://www.luisquintanilla.me/avatar.png"><meta property="og:image:secure_url" content="https://www.luisquintanilla.me/avatar.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="200"><meta property="og:image:height" content="200"><meta property="og:site_name" content="Luis Quintanilla Personal Website"><meta property="og:locale" content="en_US"><meta property="twitter:image" content="https://www.luisquintanilla.me/avatar.png"><meta name="robots" content="noindex,nofollow,nosnippet"><title>Use machine learning to categorize web links with F# and ML.NET</title></head><body><nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark"><a class="navbar-brand" href="#"><img src="/avatar.png" height="32" width="32" class="d-inline-block align-top rounded-circle" style="margin-right:5px">Luis Quintanilla</a><button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarCollapse"><ul class="navbar-nav mr-auto"><li class="nav-item active"><a class="nav-link" href="/">Home</a></li><li class="nav-item"><a class="nav-link" href="/about.html">About</a></li><li class="nav-item"><a class="nav-link" href="/contact.html">Contact</a></li><li class="nav-item"><a class="nav-link" href="/posts/1">Blog</a></li><li class="nav-item"><a class="nav-link" href="/events.html">Events</a></li></ul><a href="/feed.rss"><svg class="bi bi-rss text-secondary" fill="currentColor" viewBox="0 0 16 16" height="32" width="32"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"></path><path d="M5.5 12a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-3-8.5a1 1 0 0 1 1-1c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1-1-1zm0 4a1 1 0 0 1 1-1 6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1-1-1z"></path></svg></a></div></nav><main role="main" class="container"><div class="mr-auto"><h2>Introduction</h2>
<p>This post is part of <a href="https://sergeytihon.com/2019/11/05/f-advent-calendar-in-english-2019/">F# Advent 2019</a>. Thank you <a href="https://twitter.com/sergey_tihon">Sergey Tihon</a> for organizing this and the rest of the contributors for producing interesting, high-quality content.</p>
<p>I scan and read articles on a constant basis, such as those published as part of F# Advent. Those that I find interesting, or I want to save for later, I bookmark using <a href="https://getpocket.com/">Pocket</a>. One of the neat features it provides is tagging. You can add as many tags as you want to organize the bookmarked links. When I first started using the service, I was fairly good at adding tags. However, I've gotten lazy and don't do it as much. It would be nice if bookmarked links could automatically be categorized for me without having to provide the tags manually. Using machine learning, this task can be automated. In this writeup, I will show how to build a machine learning model using <a href="https://dotnet.microsoft.com/apps/machinelearning-ai/ml-dotnet">ML.NET</a>, a .NET, open-source, cross-platform machine learning framework to automatically categorize web links / articles.</p>
<h2>Prerequisites</h2>
<p>This application was built on a Windows 10 PC, but should work cross-platform.</p>
<ul>
<li><a href="https://dotnet.microsoft.com/download">.NET Core SDK 2.1+</a></li>
<li><a href="https://code.visualstudio.com/Download">Visual Studio Code</a></li>
<li><a href="http://ionide.io/">Ionide</a></li>
<li><a href="https://www.nuget.org/packages/Microsoft.ML/">Microsoft.ML NuGet package</a></li>
</ul>
<h2>Create the solution</h2>
<p>Make a new directory and create a solution by using the .NET CLI.</p>
<pre><code class="language-powershell">mkdir FsAdvent2019
cd FsAdvent2019
dotnet new sln
</code></pre>
<p>Then, create an F# Console application.</p>
<pre><code class="language-powershell">dotnet new console -o FsAdvent2019 -lang f#
</code></pre>
<p>Navigate to the console application directory and install the Microsoft.ML NuGet package.</p>
<pre><code class="language-powershell">cd FsAdvent2019
dotnet add package Microsoft.ML -v 1.4.0
</code></pre>
<h2>Get the data</h2>
<p><a href="https://archive.ics.uci.edu/ml/machine-learning-databases/00359/NewsAggregatorDataset.zip">Click on this link to download and unzip the data anywhere on your PC</a>.</p>
<p>The data contains information about several articles that are separated into four categories: business (b), science and technology (t), entertainment (e) and health (h). Visit the <a href="https://archive.ics.uci.edu/ml/datasets/News+Aggregator">UCI Machine Learning repository website</a> to learn more about the dataset.</p>
<p>Below is a sample of the data.</p>
<pre><code class="language-text">ID    Title    Url    Publisher    Category    Story    Hostname    Timestamp
2	Fed's Charles Plosser sees high bar for change in pace of tapering	http://www.livemint.com/Politics/H2EvwJSK2VE6OF7iK1g3PP/Feds-Charles-Plosser-sees-high-bar-for-change-in-pace-of-ta.html	Livemint	b	ddUyU0VZz0BRneMioxUPQVP6sIxvM	www.livemint.com	1394470371207
3	US open: Stocks fall after Fed official hints at accelerated tapering	http://www.ifamagazine.com/news/us-open-stocks-fall-after-fed-official-hints-at-accelerated-tapering-294436	IFA Magazine	b	ddUyU0VZz0BRneMioxUPQVP6sIxvM	www.ifamagazine.com	1394470371550
4	Fed risks falling 'behind the curve', Charles Plosser says	http://www.ifamagazine.com/news/fed-risks-falling-behind-the-curve-charles-plosser-says-294430	IFA Magazine	b	ddUyU0VZz0BRneMioxUPQVP6sIxvM	www.ifamagazine.com	1394470371793
</code></pre>
<p>Inside the console application directory, create a new directory called <em>data</em> and copy the <em>newsCorpora.csv</em> file to it.</p>
<pre><code class="language-powershell">mkdir data
</code></pre>
<h2>Define the schema</h2>
<p>Open the <em>Program.fs</em> file and add the following <code>open</code> statements at the top.</p>
<pre><code class="language-fsharp">open Microsoft.ML
open Microsoft.ML.Data
</code></pre>
<p>Directly below the <code>open</code> statements, define the data schema of the input and output of the machine learning model as records called <code>ModelInput</code> and <code>ModelOutput</code> respectively.</p>
<pre><code class="language-fsharp">[&lt;CLIMutable&gt;]
type ModelInput = {
    [&lt;LoadColumn(1)&gt;]
    Title:string
    [&lt;LoadColumn(2)&gt;]
    Url:string
    [&lt;LoadColumn(3)&gt;]
    Publisher:string
    [&lt;LoadColumn(4)&gt;]
    Category:string
    [&lt;LoadColumn(6)&gt;]
    Hostname:string
}

[&lt;CLIMutable&gt;]
type ModelOutput = {
    PredictedLabel: string
}
</code></pre>
<p>As input, only the <strong>Title</strong>, <strong>Url</strong>, <strong>Publisher</strong> and <strong>Hostname</strong> columns are used to train the machine learning model and make predictions. The label or value to predict in this case is the <strong>Category</strong>. When a prediction is output by the model, its value is stored in a column called <strong>PredictedLabel</strong>.</p>
<h2>Create the application entry point</h2>
<p>The <code>MLContext</code> is the entry point of all ML.NET applications which binds all tasks like data loading, data transformations, model training, model evaluation, and model saving/loading.</p>
<p>Inside of the <code>main</code> function, create an instance of <code>MLContext</code>.</p>
<pre><code class="language-fsharp">let mlContext = MLContext()
</code></pre>
<h2>Load the data</h2>
<p>Once the <code>MLContext</code> is initialized, use the <code>LoadFromTextFile</code> function and provide the path to the file containing the data.</p>
<pre><code class="language-fsharp">let data = mlContext.Data.LoadFromTextFile&lt;ModelInput&gt;(&quot;data/newsCorpora.csv&quot;)
</code></pre>
<h2>Create training and test datasets</h2>
<p>It's often good practice to split the data into train and test sets. The goal of a machine learning model is to accurately make predictions on data it has not seen before. Therefore, making predictions using inputs that are the same as those it was trained on may provide misleading accuracy metrics.</p>
<p>Use the <code>TrainTestSplit</code> to split the data into train / test sets with 90% of the data used for training and 10% used for testing.</p>
<pre><code class="language-fsharp">let datasets = mlContext.Data.TrainTestSplit(data,testFraction=0.1)
</code></pre>
<h2>Define the transformation and algorithm pipelines</h2>
<p>Now that the data is split, define the set of transformations to be applied to the data. The purpose of transforming the data is to convert it into numbers which are more easily processed by machine learning algorithms.</p>
<h3>Preprocessing pipeline</h3>
<p>The preprocessing pipeline contains the series of transformations that take place before training the model. To create a pipeline, initialize an <code>EstimatorChain</code> and append the desired transformations to it.</p>
<pre><code class="language-fsharp">let preProcessingPipeline = 
    EstimatorChain()
        .Append(mlContext.Transforms.Text.FeaturizeText(&quot;FeaturizedTitle&quot;,&quot;Title&quot;))
        .Append(mlContext.Transforms.Text.FeaturizeText(&quot;FeaturizedUrl&quot;,&quot;Url&quot;))
        .Append(mlContext.Transforms.Text.FeaturizeText(&quot;FeaturizedPublisher&quot;,&quot;Publisher&quot;))
        .Append(mlContext.Transforms.Text.FeaturizeText(&quot;FeaturizedHost&quot;,&quot;Hostname&quot;))
        .Append(mlContext.Transforms.Concatenate(&quot;Features&quot;,[|&quot;FeaturizedTitle&quot;; &quot;FeaturizedUrl&quot; ;&quot;FeaturizedPublisher&quot;; &quot;FeaturizedHost&quot;|]))
        .Append(mlContext.Transforms.Conversion.MapValueToKey(&quot;Label&quot;,&quot;Category&quot;))
</code></pre>
<p>In this preprocessing pipeline, the following transformations are taking place:</p>
<ol>
<li>Convert the <em>Title</em>, <em>Url</em>, <em>Publisher</em> and <em>Hostname</em> columns into numbers and store the transformed value into the <em>FeaturizedTitle</em>, <em>FeaturizedUrl</em>, <em>FeaturizedPublisher</em> and <em>FeaturizedHost</em> columns respectively.</li>
<li>Combine the <em>FeaturizedTitle</em>, <em>FeaturizedUrl</em>, <em>FeaturizedPublisher</em> and <em>FeaturizedHost</em> into one column called <em>Features</em>.</li>
<li>Create a mapping of the text value contained in the <em>Category</em> column to a numerical key and store the result into a new column called <em>Label</em>.</li>
</ol>
<h3>Algorithm pipeline</h3>
<p>The algorithm pipeline contains the algorithm used to train the machine learning model. In this application, the multiclass classification algorithm used is <code>LbfgsMaximumEntropy</code>. To learn more about the algorithm, see the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.ml.trainers.lbfgsmaximumentropymulticlasstrainer?view=ml-dotnet#training-algorithm-details">ML.NET LbfgsMaximumEntropy multiclass trainer API documentation</a>.</p>
<pre><code class="language-fsharp">let algorithm = 
    mlContext.MulticlassClassification.Trainers.LbfgsMaximumEntropy()
</code></pre>
<h3>Postprocessing pipeline</h3>
<p>The postprocessing pipeline contains the series of transformations to get the output of training into a more readable format. The only transformation performed in this pipeline is mapping back the numerical value mapping of the predicted value into text form.</p>
<pre><code class="language-fsharp">let postProcessingPipeline = 
    mlContext.Transforms.Conversion.MapKeyToValue(&quot;PredictedLabel&quot;)
</code></pre>
<h3>Create training pipeline</h3>
<p>Once the pipelines are defined, combine them into a single pipeline which applies all of the transformations to the data with a single function call.</p>
<pre><code class="language-fsharp">let trainingPipeline = 
    preProcessingPipeline
        .Append(algorithm)
        .Append(postProcessingPipeline)
</code></pre>
<h2>Train the model</h2>
<p>Use the <code>Fit</code> function to train the model by applying the set of transformations defined by <code>trainingPipeline</code> to the training dataset.</p>
<pre><code class="language-fsharp">let model =
    datasets.TrainSet |&gt; trainingPipeline.Fit
</code></pre>
<h2>Evaluate the model</h2>
<p>Once the model is trained, evaluate how well it performs against the test dataset. First, use the trained model to get the predicted category by using the <code>Transform</code> function. Then, provide the test dataset containing predictions to the <code>Evaluate</code> function which calculates the model's performance metrics by comparing the predicted category to the actual category and print some of them out.</p>
<pre><code class="language-fsharp">let metrics = 
    (datasets.TestSet |&gt; model.Transform)
    |&gt; mlContext.MulticlassClassification.Evaluate

printfn &quot;Log Loss: %f | MacroAccuracy: %f&quot; metrics.LogLoss metrics.MacroAccuracy
</code></pre>
<h2>Using the model on real data</h2>
<p>Create a list of <code>ModelInput</code> items and use the <code>Transform</code> method to get the predicted category.</p>
<pre><code class="language-fsharp">let predictions = 
    [
        { 
            Title=&quot;A FIRST LOOK AT SURFACE DUO, MICROSOFT’S FOLDABLE ANDROID PHONE&quot;
            Url=&quot;https://www.theverge.com/2019/10/3/20895268/microsoft-surface-duo-foldable-phone-dual-screen-android-hands-on-features-price-photos-video&quot;
            Publisher=&quot;The Verge&quot;
            Hostname=&quot;www.theverge.com&quot; 
            Category = &quot;&quot; 
        }
        { 
            Title=&quot;This Shrinking Economy With Low Inflation Is Stuck on Rates&quot;
            Url=&quot;https://www.bloomberg.com/news/articles/2019-12-12/when-a-shrinking-economy-and-low-inflation-don-t-mean-rate-cuts?srnd=economics-vp&quot;
            Publisher=&quot;Bloomberg&quot;
            Hostname=&quot;www.bloomberg.com&quot; 
            Category = &quot;&quot; 
        }
    ] 
    |&gt; mlContext.Data.LoadFromEnumerable
    |&gt; model.Transform
</code></pre>
<p>Then, create a <code>Sequence</code> of <code>ModelOutput</code> values and print out the <em>PredictedLabel</em> values.</p>
<pre><code class="language-fsharp">mlContext.Data.CreateEnumerable&lt;ModelOutput&gt;(predictions,false)
|&gt; Seq.iter(fun prediction -&gt; printfn &quot;Predicted Value: %s&quot; prediction.PredictedLabel)
</code></pre>
<p>The final <em>Program.fs</em> file should look as follows:</p>
<pre><code class="language-fsharp">open System
open Microsoft.ML
open Microsoft.ML.Data

[&lt;CLIMutable&gt;]
type ModelInput = {
    [&lt;LoadColumn(1)&gt;]
    Title:string
    [&lt;LoadColumn(2)&gt;]
    Url:string
    [&lt;LoadColumn(3)&gt;]
    Publisher:string
    [&lt;LoadColumn(4)&gt;]
    Category:string
    [&lt;LoadColumn(6)&gt;]
    Hostname:string
}

[&lt;CLIMutable&gt;]
type ModelOutput = {
    PredictedLabel: string
}

[&lt;EntryPoint&gt;]
let main argv =

    let mlContext = MLContext()

    let data = mlContext.Data.LoadFromTextFile&lt;ModelInput&gt;(&quot;data/newsCorpora.csv&quot;)

    let datasets = mlContext.Data.TrainTestSplit(data,testFraction=0.1)

    let preProcessingPipeline = 
        EstimatorChain()
            .Append(mlContext.Transforms.Text.FeaturizeText(&quot;FeaturizedTitle&quot;,&quot;Title&quot;))
            .Append(mlContext.Transforms.Text.FeaturizeText(&quot;FeaturizedUrl&quot;,&quot;Url&quot;))
            .Append(mlContext.Transforms.Text.FeaturizeText(&quot;FeaturizedPublisher&quot;,&quot;Publisher&quot;))
            .Append(mlContext.Transforms.Text.FeaturizeText(&quot;FeaturizedHost&quot;,&quot;Hostname&quot;))
            .Append(mlContext.Transforms.Concatenate(&quot;Features&quot;,[|&quot;FeaturizedTitle&quot;; &quot;FeaturizedUrl&quot; ;&quot;FeaturizedPublisher&quot;; &quot;FeaturizedHost&quot;|]))
            .Append(mlContext.Transforms.Conversion.MapValueToKey(&quot;Label&quot;,&quot;Category&quot;))

    let algorithm = 
        mlContext.MulticlassClassification.Trainers.LbfgsMaximumEntropy()

    let postProcessingPipeline = 
        mlContext.Transforms.Conversion.MapKeyToValue(&quot;PredictedLabel&quot;)

    let trainingPipeline = 
        preProcessingPipeline
            .Append(algorithm)
            .Append(postProcessingPipeline)

    let model =
        datasets.TrainSet |&gt; trainingPipeline.Fit

    let metrics = 
        (datasets.TestSet |&gt; model.Transform)
        |&gt; mlContext.MulticlassClassification.Evaluate

    printfn &quot;Log Loss: %f | MacroAccuracy: %f&quot; metrics.LogLoss metrics.MacroAccuracy

    let predictions = 
        [
            { 
                Title=&quot;A FIRST LOOK AT SURFACE DUO, MICROSOFT’S FOLDABLE ANDROID PHONE&quot;
                Url=&quot;https://www.theverge.com/2019/10/3/20895268/microsoft-surface-duo-foldable-phone-dual-screen-android-hands-on-features-price-photos-video&quot;
                Publisher=&quot;The Verge&quot;
                Hostname=&quot;www.theverge.com&quot; 
                Category = &quot;&quot; 
            }
            { 
                Title=&quot;This Shrinking Economy With Low Inflation Is Stuck on Rates&quot;
                Url=&quot;https://www.bloomberg.com/news/articles/2019-12-12/when-a-shrinking-economy-and-low-inflation-don-t-mean-rate-cuts?srnd=economics-vp&quot;
                Publisher=&quot;Bloomberg&quot;
                Hostname=&quot;www.bloomberg.com&quot; 
                Category = &quot;&quot; 
            }
        ] 
        |&gt; mlContext.Data.LoadFromEnumerable
        |&gt; model.Transform
 
    mlContext.Data.CreateEnumerable&lt;ModelOutput&gt;(predictions,false)
    |&gt; Seq.iter(fun prediction -&gt; printfn &quot;Predicted Value: %s&quot; prediction.PredictedLabel)

    0 // return an integer exit code
</code></pre>
<h2>Run the application</h2>
<p>This particular model achieved a macro-accuracy of 0.92, where closer to 1 is preferred and log loss of 0.20 where closer to 0 is preferred.</p>
<pre><code class="language-bash">Log Loss: 0.200502 | MacroAccuracy: 0.927742
</code></pre>
<p>The predicted values are the following:</p>
<pre><code class="language-bash">Predicted Value: t
Predicted Value: b
</code></pre>
<p>Upon inspection, they appear to be correct, science and technology for the first link and business for the second link.</p>
<h2>Conclusion</h2>
<p>In this writeup, I showed how to build a machine learning multiclass classification model that categorizes web links using ML.NET. Now that you have a model trained, you can save it and deploy it in another application (desktop, web) that bookmarks links. This model can be further improved and personalized by using data from Pocket which has already been tagged. Happy coding!</p>
</div></main><script src="/js/jquery.slim.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/highlight.min.js"></script><script src="/js/highlight.fsharp.min.js"></script><script type="application/javascript">hljs.initHighlightingOnLoad();</script></body><footer><a rel="me" href="https://toot.lqdev.tech/@lqdev"></a></footer></html>